<!doctype html>
<html lang="ja">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- Bootstrap + Icon CSS -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta1/dist/css/bootstrap.min.css"
    crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.5.0/font/bootstrap-icons.css"
    crossorigin="anonymous">
  <title>Simple Book Search</title>
</head>

<body>
  <!-- Bootstrap + Vue.js Script -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta1/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-ygbV9kiqUc6oa4msXn9868pTtWMgiQaeYH7/t7LECLbyPA2x65Kgf80OJFdroafW"
    crossorigin="anonymous"></script>
  <script src="https://unpkg.com/vue@3.0.11/dist/vue.global.js"></script>
  <article class="container">
    <h1>Simple Book Search</h1>
    <h2 class="visually-hidden">検索フォーム</h2>
    <form name="searchConditions" class="row g-2 mb-4">
      <div class="col-12 col-lg-6">
        <div class="form-floating">
          <input type="text" class="form-control" id="keyword" value="Web デザイン"></input>
          <label for="keyword" class="form-label">キーワード</label>
        </div>
      </div>
      <div class="col-12 col-sm-6 col-md-5 col-lg-2">
        <div class="form-floating">
          <input type="number" class="form-control" id="from" value="2016"></input>
          <label for="from" class="form-label">出版年（開始）</label>
        </div>
      </div>
      <div class="col-12 col-sm-6 col-md-5 col-lg-2">
        <div class="form-floating">
          <input type="number" class="form-control" id="to" value="2021"></input>
          <label for="to" class="form-label">出版年（終了）</label>
        </div>
      </div>
      </div>
      <div class="col-12 col-md-2 col-lg-2">
        <button type="button" class="btn btn-primary" style="height:100%;width:100%" onclick="doSearch()">
          <i class="bi bi-search"></i>検索
        </button>
      </div>
    </form>
    <section id="resList" class="row row-cols-1 g-2">
      <h2 class="visually-hidden">検索結果</h2>
      <p v-if="totalResults">{{totalResults}}件ヒット</p>
      <div class="row col-12 mb-4" v-for="item in items">
        <div class="col-2">
          <img v-if="item.isbn" v-bind:src="item.thumbnailUrl" alt="" class="img-fluid thumbnail"
            onerror="this.classList.add('invisible')">
        </div>
        <div class="col-10 row align-top">
          <h3 class="fs-5 col-12"><a v-bind:href="item.ciniiUrl">{{item.title}}</a></h3>
          <div class="col-12 col-md-8">
            <ul class="list-unstyled" style="margin-bottom:0">
              <li><i class="bi bi-emoji-smile"></i>{{item.creator}}</li>
              <li><i class="bi bi-building"></i>{{item.publisher}} <i class="bi bi-calendar"></i>{{item.issued}}</li>
            </ul>
          </div>
          <div class="col-12 col-md-4">
            <ul class="list-unstyled" style="margin-bottom:0">
              <li><i class="bi bi-upc"></i><span class="visually-hidden">ISBN: </span>{{item.isbn}}</li>
              <li><i class="bi bi-bookshelf"></i><span class="visually-hidden">所蔵館数: </span>{{item.ownerCount}}</li>
            </ul>
          </div>
          <div class="col-12 text-muted overflow-hidden" v-if="item.introduction" style="max-height:4.5rem">
            <small>{{item.introduction}}</small>
          </div>
        </div>
      </div>
    </section>
  </article>
  <script>
    function ciniiReqUrlBuilder(p = 1) {
      let ciniiReqUrl = "https://ci.nii.ac.jp/books/opensearch/search?format=json&ndc=&sortorder=5"
      let keyword = document.forms.searchConditions.keyword.value;
      let from = document.forms.searchConditions.from.value;
      let to = document.forms.searchConditions.to.value;
      ciniiReqUrl += "&q=" + encodeURIComponent(keyword);
      ciniiReqUrl += "&year_from=" + from;
      ciniiReqUrl += "&year_to=" + to;
      ciniiReqUrl += "&p=" + p;
      return ciniiReqUrl;
    }
    async function getJson(url) {
      //console.log("requesting: "+url);
      return await (await fetch(url)).json();
    }


    const resListApp = Vue.createApp({
      data() {
        return {
          items: null,
          totalResults: null,
          reviewAverage: null,
          reviewAverage: null
        }
      }
    })

    const resList = resListApp.mount('#resList')

    async function getIntro(isbn) {
      let openBDUrl = "https://api.openbd.jp/v1/get?isbn=" + isbn
      let openBDJson = await getJson(openBDUrl)
      if (openBDJson[0]) {
        let txtArray = openBDJson[0].onix.CollateralDetail.TextContent
        for (var i in txtArray) {
          if (txtArray[i].TextType == "03") {
            return txtArray[i].Text
          }
        }
      }
    }

    
    async function getReview(isbn) {
      let rakutenUrl = "https://app.rakuten.co.jp/services/api/BooksBook/Search/20170404?applicationId=1053729486094210141";
      rakutenUrl += "elements=isbn,reviewCount,reviewAverage,itemCaption,largeImageUrl"
      rakutenUrl += "isbn=" + isbn;
      let rakutenJson = await getJson(rakutenUrl);
      if (rakutenJson.Items) {
        console.log(rakutenJson.Items[0])
        let reviewAverage = rakutenJson.Items[0].reviewAverage;
        let reviewCount = rakutenJson.Items[0].reviewCount;
        return {
          reviewAverage: reviewAverage,
          reviewCount: reviewCount
        }
      }
    }
    


    async function doSearch() {
      //初期化
      thumbnailImgElm = document.getElementsByClassName("thumbnail");
      for (let i = 0; i < thumbnailImgElm.length; i++) {
        thumbnailImgElm[i].classList.remove("invisible")
      }
      resList.items = [];
      resList.totalResults = null;


      let url = ciniiReqUrlBuilder();
      let ciniiList = await getJson(url);
      const resItems = ciniiList["@graph"][0].items;
      const totalResults = ciniiList["@graph"][0]["opensearch:totalResults"];
      resList.totalResults = totalResults;
      let items = []
      for (var i in resItems) {
        item = resItems[i]
        let exItem = {
          title: item["title"],
          ciniiUrl: item["@id"],
          creator: item["dc:creator"],
          issued: item["dc:date"],
          publisher: item["dc:publisher"].join(", "),
          ownerCount: item["cinii:ownerCount"],
        }
        if (item["dcterms:hasPart"]) {
          let isbn = item["dcterms:hasPart"][0]["@id"].replace(/urn:isbn:([0-9X]{10}|[0-9]{13})/, "$1")
          exItem.isbn = isbn
          exItem.thumbnailUrl = "https://iss.ndl.go.jp/thumbnail/" + isbn
        }
        items.push(exItem)
      }
      console.log(items)
      resList.items = items;

      for (var i in items) {
        let intro = await getIntro(items[i].isbn)
        resList.items[i].introduction = intro
      }

      //レビュー取得処理 調整中
      
      for (var i in items) {
        let reviewInfo = await getReview(items[i].isbn)
        if(reviewInfo){
          if (reviewInfo.reviewCount > 0) {
            //console.log(reviewInfo)
            //resList.items[i].reviewCount = reviewInfo.reviewCount
            //resList.items[i].reviewAvarage = reviewInfo.reviewAvarage
          }
        }
      }
      

    }

  </script>
</body>

</html>